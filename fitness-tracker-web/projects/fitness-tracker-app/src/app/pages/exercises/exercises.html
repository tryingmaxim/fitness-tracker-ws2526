<div class="page">
  <h1>Übungen</h1>

  <p class="sub">
    <ng-container *ngIf="isLoggedIn; else publicHint">
      Verwalte deine angelegten Übungen und bearbeite die Details.
    </ng-container>
    <ng-template #publicHint>
      Du kannst Übungen ansehen und suchen. Zum Anlegen, Bearbeiten oder Löschen bitte anmelden.
    </ng-template>
  </p>

  <div class="alerts" *ngIf="error || info">
    <div class="alert error" *ngIf="error">{{ error }}</div>
    <div class="alert info" *ngIf="info">{{ info }}</div>
  </div>

  <section class="panel create-panel" *ngIf="isLoggedIn">
    <h2>Neue Übung anlegen</h2>

    <p class="hint">
      Lege hier neue Übungen an. Name, Kategorie und Muskelgruppen sind Pflichtfelder.
    </p>

    <form class="form" #createForm="ngForm" (ngSubmit)="addExercise(createForm)">
      <input [(ngModel)]="form.name" name="name" placeholder="Name (z.B. Bankdrücken)" required />

      <input [(ngModel)]="form.category" name="category" placeholder="Kategorie (z.B. Freihantel)" required />

      <input
        [(ngModel)]="form.muscleGroups"
        name="muscleGroups"
        placeholder="Muskelgruppen (z.B.Trizeps)"
        required
      />

      <textarea [(ngModel)]="form.description" name="description" placeholder="Beschreibung (optional)"></textarea>

      <button type="submit" [disabled]="submitting">
        {{ submitting ? 'Wird angelegt...' : 'Hinzufügen' }}
      </button>
    </form>
  </section>

  <div class="layout">
    <section class="panel overview">
      <div class="overview-head">
        <h2>Übersicht</h2>
        <span class="count-badge">{{ exercises.length }}</span>
      </div>

      <input
        type="text"
        class="exercise-search"
        placeholder="Übung suchen..."
        [(ngModel)]="exerciseOverviewSearch"
        (input)="onExerciseOverviewSearchChange()"
      />

      <p class="muted" *ngIf="loading">Übungen werden geladen...</p>
      <p class="muted" *ngIf="!loading && !filteredExerciseOverview.length">Keine Übung gefunden.</p>

      <ul class="list">
        <li
          *ngFor="let ex of filteredExerciseOverview; trackBy: trackByExercise"
          (click)="selectExercise(ex)"
          [class.active]="selectedExercise?.id === ex.id"
        >
          <div class="exercise-info">
            <div>
              <h3>{{ ex.name }}</h3>

              <p class="meta">
                Kategorie:
                <strong>{{ ex.category || '–' }}</strong>
              </p>

              <p class="meta" *ngIf="ex.muscleGroups; else noMuscles">
                Muskelgruppen: {{ ex.muscleGroups }}
              </p>
              <ng-template #noMuscles>
                <p class="meta muted">Keine Muskelgruppen hinterlegt</p>
              </ng-template>

              <p class="desc" *ngIf="ex.description; else noDesc">{{ ex.description }}</p>
              <ng-template #noDesc>
                <p class="desc muted">Keine Beschreibung hinterlegt</p>
              </ng-template>
            </div>
          </div>

          <div class="exercise-actions">
            <button type="button" class="ghost" (click)="selectExercise(ex); $event.stopPropagation()">
              Details
            </button>

            <button *ngIf="isLoggedIn" type="button" class="danger" (click)="deleteExercise(ex, $event)">
              Löschen
            </button>
          </div>
        </li>
      </ul>
    </section>

    <section class="panel details" *ngIf="selectedExercise; else selectHint">
      <div class="details-head">
        <button type="button" class="back" (click)="resetSelection()">← Zurück zur Übersicht</button>
        <h2>Details: {{ selectedExercise.name }}</h2>
      </div>

      <ng-container *ngIf="!isLoggedIn; else editBlock">
        <div class="read-only">
          <p class="meta"><strong>Name:</strong> {{ editForm.name }}</p>
          <p class="meta"><strong>Kategorie:</strong> {{ editForm.category }}</p>
          <p class="meta"><strong>Muskelgruppen:</strong> {{ editForm.muscleGroups }}</p>
          <p class="meta"><strong>Beschreibung:</strong> {{ editForm.description || '–' }}</p>

          <p class="muted" style="margin-top: 12px;">Zum Bearbeiten bitte anmelden.</p>
        </div>
      </ng-container>

      <ng-template #editBlock>
        <form class="edit-form" (ngSubmit)="saveSelected()">
          <label for="editName">Name</label>
          <input id="editName" name="editName" [(ngModel)]="editForm.name" required />

          <label for="editCategory">Kategorie</label>
          <input id="editCategory" name="editCategory" [(ngModel)]="editForm.category" required />

          <label for="editMuscles">Muskelgruppen</label>
          <input id="editMuscles" name="editMuscles" [(ngModel)]="editForm.muscleGroups" required />

          <label for="editDesc">Beschreibung</label>
          <textarea id="editDesc" name="editDesc" [(ngModel)]="editForm.description"></textarea>

          <button type="submit" [disabled]="saving">
            {{ saving ? 'Speichern...' : 'Änderungen speichern' }}
          </button>
        </form>
      </ng-template>
    </section>

    <ng-template #selectHint>
      <section class="panel details placeholder">
        <p>Wähle eine Übung aus der Übersicht, um Details zu sehen.</p>
        <p class="muted" *ngIf="!isLoggedIn">Bearbeiten/Löschen/Anlegen ist nur nach Anmeldung möglich.</p>
      </section>
    </ng-template>
  </div>
</div>
