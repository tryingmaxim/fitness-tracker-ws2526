<div class="sessions-page">
  <h1>Sessions planen</h1>

  <p class="sub">
    <ng-container *ngIf="isLoggedIn; else publicHint">
      Ordne neue Trainingseinheiten einem vorhandenen Plan zu, damit sie im Übersicht-Modul
      erscheinen.
    </ng-container>
    <ng-template #publicHint>
      Du kannst Sessions ansehen. Zum Anlegen, Bearbeiten oder Löschen bitte anmelden.
    </ng-template>
  </p>

  <div class="alert error" *ngIf="errorMsg">
    {{ errorMsg }}
  </div>
  <div class="alert info" *ngIf="infoMsg">
    {{ infoMsg }}
  </div>

  <div class="top-grid" *ngIf="isLoggedIn">
    <div class="session-card">
      <h2 class="card-title">Neue Session anlegen</h2>
      <p class="card-sub">
        Wähle einen Plan, vergib einen Namen und wähle die Tage (1–30) für deine Trainingseinheit.
      </p>

      <form class="form" (ngSubmit)="add()" novalidate>
        <label for="planSelect">Trainingsplan</label>
        <select
          id="planSelect"
          [(ngModel)]="form.planId"
          name="planId"
          [disabled]="loadingPlans || !plans.length || creating"
          required
        >
          <option [ngValue]="null" disabled>
            {{ loadingPlans ? 'Trainingspläne werden geladen...' : 'Kein Plan vorhanden' }}
          </option>
          <option *ngFor="let p of plans" [ngValue]="p.id">
            {{ p.name }}
          </option>
        </select>

        <label for="sessionName">Session-Name</label>
        <input
          id="sessionName"
          [(ngModel)]="form.name"
          name="name"
          placeholder="z. B. Push Day"
          [disabled]="creating"
          required
          autocomplete="off"
        />

        <label id="createDaysLabel">Tage (1–30)</label>
        <div class="days-toolbar">
          <button
            type="button"
            class="days-clear"
            (click)="clearDaysCreate()"
            [disabled]="creating || !form.days.length"
          >
            Auswahl löschen
          </button>
          <span class="muted small">Ausgewählt: {{ formatDays(form.days) }}</span>
        </div>

        <div class="days-grid" [class.disabled]="creating" role="group" aria-labelledby="createDaysLabel">
          <button
            type="button"
            class="day-btn"
            *ngFor="let d of dayOptions"
            (click)="toggleDayCreate(d)"
            [class.selected]="isDaySelectedCreate(d)"
            [class.blocked]="isDayBlockedCreate(d)"
            [disabled]="creating || (!isDaySelectedCreate(d) && isDayBlockedCreate(d))"
            [attr.title]="isDayBlockedCreate(d) ? 'Dieser Tag ist im Plan schon belegt' : null"
            [attr.aria-pressed]="isDaySelectedCreate(d)"
          >
            {{ d }}
          </button>
        </div>

        <button type="submit" [disabled]="creating || !plans.length">
          {{ creating ? 'Session wird angelegt...' : 'Session hinzufügen' }}
        </button>
      </form>
    </div>

    <div class="exercise-card">
      <div class="exercise-card-header">
        <div>
          <h2 class="card-title">Übungen für diese Session</h2>
          <p class="card-sub">
            Wähle hier Übungen aus deinem Übungspool aus. Danach kannst du Priorität, Sätze, Wdh und
            Gewicht anpassen.
          </p>
        </div>
        <span class="badge">{{ selectedExecutions.length }}</span>
      </div>

      <label class="sr-only" for="createExerciseSearch">Übung nach Name filtern</label>
      <input
        id="createExerciseSearch"
        class="search-input"
        type="text"
        placeholder="Übung nach Name filtern..."
        [(ngModel)]="exerciseSearch"
        name="exerciseSearch"
        (input)="onExerciseSearchChange()"
        [disabled]="loadingExercises"
        autocomplete="off"
      />

      <div class="exercise-list" *ngIf="!loadingExercises && filteredExercises.length">
        <button
          type="button"
          class="exercise-item"
          *ngFor="let ex of filteredExercises; trackBy: trackByExercise"
          (click)="toggleExercise(ex)"
        >
          <div class="exercise-main">
            <span class="exercise-name">{{ ex.name }}</span>
            <span class="exercise-meta">
              {{ ex.category || 'Kategorie unbekannt' }}
              <span *ngIf="ex.muscleGroups">· {{ ex.muscleGroups }}</span>
            </span>
          </div>
          <div class="exercise-check" [class.selected]="isExerciseSelected(ex)">
            <span *ngIf="isExerciseSelected(ex)">✓</span>
          </div>
        </button>
      </div>

      <p class="muted small" *ngIf="!loadingExercises && !filteredExercises.length">
        Keine Übung gefunden. Passe deinen Suchbegriff an.
      </p>
      <p class="muted small" *ngIf="loadingExercises">Übungen werden geladen...</p>

      <div class="exec-config-card" *ngIf="selectedExecutions.length">
        <div class="exec-config-header">
          <h3 class="exec-config-title">Ausgewählte Übungen</h3>
          <span class="muted small">Tip: Priorität = Reihenfolge in der Session</span>
        </div>

        <div class="exec-config-list">
          <div class="exec-config-row" *ngFor="let d of selectedExecutions; let i = index">
            <div class="exec-name">
              <span class="exec-name-text">{{ getExerciseName(d.exerciseId) }}</span>
              <button type="button" class="exec-remove" (click)="removeExecutionDraftCreate(d.exerciseId)">
                ×
              </button>
            </div>

            <div class="exec-fields">
              <div class="exec-field">
                <span class="mini-label">Prio</span>

                <div class="prio-controls">
                  <button type="button" class="prio-btn" (click)="moveCreateUp(i)" [disabled]="i === 0">
                    ↑
                  </button>

                  <button type="button" class="prio-btn" disabled>
                    {{ i + 1 }}
                  </button>

                  <button
                    type="button"
                    class="prio-btn"
                    (click)="moveCreateDown(i)"
                    [disabled]="i === selectedExecutions.length - 1"
                  >
                    ↓
                  </button>
                </div>
              </div>

              <div class="exec-field">
                <label class="mini-label" [attr.for]="'c_sets_' + d.exerciseId">Sätze</label>
                <input
                  [id]="'c_sets_' + d.exerciseId"
                  type="number"
                  min="1"
                  [(ngModel)]="d.plannedSets"
                  [name]="'c_sets_' + d.exerciseId"
                />
              </div>

              <div class="exec-field">
                <label class="mini-label" [attr.for]="'c_reps_' + d.exerciseId">Wdh</label>
                <input
                  [id]="'c_reps_' + d.exerciseId"
                  type="number"
                  min="1"
                  [(ngModel)]="d.plannedReps"
                  [name]="'c_reps_' + d.exerciseId"
                />
              </div>

              <div class="exec-field">
                <label class="mini-label" [attr.for]="'c_kg_' + d.exerciseId">Kg</label>
                <input
                  [id]="'c_kg_' + d.exerciseId"
                  type="number"
                  min="0"
                  step="0.5"
                  [(ngModel)]="d.plannedWeightKg"
                  [name]="'c_kg_' + d.exerciseId"
                />
              </div>
            </div>

            <div class="exec-notes">
              <label class="sr-only" [attr.for]="'c_notes_' + d.exerciseId">Notiz</label>
              <input
                [id]="'c_notes_' + d.exerciseId"
                type="text"
                placeholder="Notiz (optional)"
                [(ngModel)]="d.notes"
                [name]="'c_notes_' + d.exerciseId"
                autocomplete="off"
              />
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <p class="muted small" *ngIf="loadingSessions">Sessions werden geladen...</p>
  <p class="muted small" *ngIf="!loadingSessions && !sessions.length">
    Noch keine Sessions geplant.
  </p>

  <div class="sessions-bottom-grid" *ngIf="!loadingSessions && sessions.length">
    <div class="sessions-overview-card">
      <div class="sessions-list-header">
        <div>
          <h2 class="card-title">Übersicht</h2>
          <p class="card-sub">Deine geplanten Sessions mit Tagen, Plan und hinterlegten Übungen.</p>
        </div>
        <span class="badge">{{ filteredSessionsForOverview.length }}</span>
      </div>

      <label class="sr-only" for="sessionsSearch">Session suchen</label>
      <input
        id="sessionsSearch"
        class="search-input"
        type="text"
        placeholder="Session suchen..."
        [(ngModel)]="sessionSearch"
        name="sessionSearch"
        autocomplete="off"
      />

      <div class="sessions-list">
        <button
          type="button"
          class="session-item"
          *ngFor="let s of filteredSessionsForOverview; trackBy: trackBySession"
          [class.selected]="selectedSession?.id === s.id"
          (click)="selectSession(s)"
        >
          <div class="session-main">
            <span class="session-name">{{ s.name }}</span>
            <span class="session-meta"><strong>Tage:</strong> {{ formatDays(s.days) }}</span>
            <span class="session-meta"><strong>Plan:</strong> {{ getPlanName(s.planId, s.planName) }}</span>
            <span class="session-meta"><strong>Übungen:</strong> {{ joinExerciseNames(s) }}</span>
          </div>

          <div class="session-actions">
            <button type="button" (click)="selectSession(s)">Details</button>

            <button
              *ngIf="isLoggedIn"
              type="button"
              class="btn-danger"
              (click)="deleteSession(s, $event)"
              [disabled]="deleting && deleteId === s.id"
            >
              {{ deleting && deleteId === s.id ? 'Löschen...' : 'Löschen' }}
            </button>
          </div>
        </button>
      </div>
    </div>

    <ng-container *ngIf="selectedSession; else noSelectionBlock">
      <div class="sessions-detail-card">
        <div class="sessions-detail-header">
          <button type="button" class="sessions-detail-back" (click)="clearSelection()">
            ← Zurück zur Übersicht
          </button>
          <h2 class="card-title">Details: {{ detailForm.name || selectedSession.name }}</h2>
          <p class="card-sub">
            <ng-container *ngIf="isLoggedIn; else readonlyHint">
              Bearbeite Name, Plan, Tage und Übungs-Konfiguration (Priorität/Sätze/Wdh/Gewicht).
            </ng-container>
            <ng-template #readonlyHint>
              Du kannst Details ansehen. Zum Bearbeiten bitte anmelden.
            </ng-template>
          </p>
        </div>

        <ng-container *ngIf="!isLoggedIn; else editFormBlock">
          <div class="read-only">
            <p class="meta"><strong>Name:</strong> {{ detailForm.name }}</p>
            <p class="meta"><strong>Plan:</strong> {{ getPlanName(detailForm.planId, selectedSession.planName) }}</p>
            <p class="meta"><strong>Tage:</strong> {{ formatDays(detailForm.days) }}</p>

            <div class="exec-config-card" *ngIf="detailExecutions.length">
              <div class="exec-config-header">
                <h3 class="exec-config-title">Übungen</h3>
              </div>

              <div class="exec-config-list">
                <div class="exec-config-row" *ngFor="let d of detailExecutions; let i = index">
                  <div class="exec-name">
                    <span class="exec-name-text">{{ i + 1 }}. {{ getExerciseName(d.exerciseId) }}</span>
                  </div>

                  <div class="exec-fields">
                    <div class="exec-field">
                      <span class="mini-label">Sätze</span>
                      <div>{{ d.plannedSets }}</div>
                    </div>
                    <div class="exec-field">
                      <span class="mini-label">Wdh</span>
                      <div>{{ d.plannedReps }}</div>
                    </div>
                    <div class="exec-field">
                      <span class="mini-label">Kg</span>
                      <div>{{ d.plannedWeightKg }}</div>
                    </div>
                  </div>

                  <div class="exec-notes" *ngIf="d.notes">
                    <div class="muted small">{{ d.notes }}</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </ng-container>

        <ng-template #editFormBlock>
          <form class="sessions-detail-form" novalidate>
            <label for="detailName">Name</label>
            <input
              id="detailName"
              [(ngModel)]="detailForm.name"
              name="detailName"
              [disabled]="updating || detailLoading"
              required
              autocomplete="off"
            />

            <label for="detailPlan">Kategorie / Trainingsplan</label>
            <select
              id="detailPlan"
              [(ngModel)]="detailForm.planId"
              (ngModelChange)="onDetailPlanChange()"
              name="detailPlanId"
              [disabled]="updating || detailLoading || loadingPlans || !plans.length"
              required
            >
              <option [ngValue]="null" disabled>Bitte Plan wählen</option>
              <option *ngFor="let p of plans" [ngValue]="p.id">{{ p.name }}</option>
            </select>

            <label id="detailDaysLabel">Tage (1–30)</label>
            <div class="days-toolbar">
              <button
                type="button"
                class="days-clear"
                (click)="clearDaysDetail()"
                [disabled]="updating || detailLoading || !detailForm.days.length"
              >
                Auswahl löschen
              </button>
              <span class="muted small">Ausgewählt: {{ formatDays(detailForm.days) }}</span>
            </div>

            <div
              class="days-grid"
              [class.disabled]="updating || detailLoading"
              role="group"
              aria-labelledby="detailDaysLabel"
            >
              <button
                type="button"
                class="day-btn"
                *ngFor="let d of dayOptions"
                (click)="toggleDayDetail(d)"
                [class.selected]="isDaySelectedDetail(d)"
                [class.blocked]="isDayBlockedDetail(d)"
                [disabled]="updating || detailLoading || (!isDaySelectedDetail(d) && isDayBlockedDetail(d))"
                [attr.title]="isDayBlockedDetail(d) ? 'Dieser Tag ist im Plan schon belegt' : null"
                [attr.aria-pressed]="isDaySelectedDetail(d)"
              >
                {{ d }}
              </button>
            </div>

            <label>Übungen in dieser Session</label>

            <div class="exec-config-card" *ngIf="detailExecutions.length">
              <div class="exec-config-header">
                <h3 class="exec-config-title">Konfiguration</h3>
                <span class="muted small">Priorität = Reihenfolge</span>
              </div>

              <div class="exec-config-list">
                <div class="exec-config-row" *ngFor="let d of detailExecutions; let i = index">
                  <div class="exec-name">
                    <span class="exec-name-text">{{ getExerciseName(d.exerciseId) }}</span>
                    <button type="button" class="exec-remove" (click)="removeExecutionDraftDetail(d.exerciseId)">
                      ×
                    </button>
                  </div>

                  <div class="exec-fields">
                    <div class="exec-field">
                      <span class="mini-label">Prio</span>
                      <div class="prio-controls">
                        <button
                          type="button"
                          class="prio-btn"
                          (click)="moveDetailUp(i)"
                          [disabled]="i === 0 || updating || detailLoading"
                        >
                          ↑
                        </button>

                        <button type="button" class="prio-btn" [disabled]="true">
                          {{ i + 1 }}
                        </button>

                        <button
                          type="button"
                          class="prio-btn"
                          (click)="moveDetailDown(i)"
                          [disabled]="i === detailExecutions.length - 1 || updating || detailLoading"
                        >
                          ↓
                        </button>
                      </div>
                    </div>

                    <div class="exec-field">
                      <label class="mini-label" [attr.for]="'d_sets_' + d.exerciseId">Sätze</label>
                      <input
                        [id]="'d_sets_' + d.exerciseId"
                        type="number"
                        min="1"
                        [(ngModel)]="d.plannedSets"
                        [name]="'d_sets_' + d.exerciseId"
                        [disabled]="updating || detailLoading"
                      />
                    </div>

                    <div class="exec-field">
                      <label class="mini-label" [attr.for]="'d_reps_' + d.exerciseId">Wdh</label>
                      <input
                        [id]="'d_reps_' + d.exerciseId"
                        type="number"
                        min="1"
                        [(ngModel)]="d.plannedReps"
                        [name]="'d_reps_' + d.exerciseId"
                        [disabled]="updating || detailLoading"
                      />
                    </div>

                    <div class="exec-field">
                      <label class="mini-label" [attr.for]="'d_kg_' + d.exerciseId">Kg</label>
                      <input
                        [id]="'d_kg_' + d.exerciseId"
                        type="number"
                        min="0"
                        step="0.5"
                        [(ngModel)]="d.plannedWeightKg"
                        [name]="'d_kg_' + d.exerciseId"
                        [disabled]="updating || detailLoading"
                      />
                    </div>
                  </div>

                  <div class="exec-notes">
                    <label class="sr-only" [attr.for]="'d_notes_' + d.exerciseId">Notiz</label>
                    <input
                      [id]="'d_notes_' + d.exerciseId"
                      type="text"
                      placeholder="Notiz (optional)"
                      [(ngModel)]="d.notes"
                      [name]="'d_notes_' + d.exerciseId"
                      [disabled]="updating || detailLoading"
                      autocomplete="off"
                    />
                  </div>
                </div>
              </div>
            </div>

            <label class="sr-only" for="detailExerciseSearchInput">Weitere Übung hinzufügen</label>
            <input
              id="detailExerciseSearchInput"
              class="search-input"
              type="text"
              [(ngModel)]="detailExerciseSearch"
              name="detailExerciseSearch"
              placeholder="Übung nach Name filtern..."
              (input)="onDetailExerciseSearchChange()"
              [disabled]="detailLoading || loadingExercises"
              autocomplete="off"
            />

            <div class="exercise-list" *ngIf="availableDetailExercises.length && !loadingExercises">
              <button
                type="button"
                class="exercise-item"
                *ngFor="let ex of availableDetailExercises; trackBy: trackByExercise"
                (click)="addExerciseToDetail(ex)"
              >
                <div class="exercise-main">
                  <span class="exercise-name">{{ ex.name }}</span>
                  <span class="exercise-meta">
                    {{ ex.category || 'Kategorie unbekannt' }}
                    <span *ngIf="ex.muscleGroups">· {{ ex.muscleGroups }}</span>
                  </span>
                </div>
              </button>
            </div>

            <p class="muted small" *ngIf="loadingExercises">Übungen werden geladen...</p>

            <button type="button" (click)="updateSelectedSession()" [disabled]="updating || detailLoading">
              {{ updating ? 'Änderungen werden gespeichert...' : 'Änderungen speichern' }}
            </button>
          </form>
        </ng-template>
      </div>
    </ng-container>

    <ng-template #noSelectionBlock>
      <div class="sessions-detail-card">
        <h2 class="card-title">Details</h2>
        <p class="card-sub">Wähle links eine Session aus, um Details zu sehen.</p>
        <p class="muted small" *ngIf="!isLoggedIn">Zum Bearbeiten bitte anmelden.</p>
      </div>
    </ng-template>
  </div>
</div>
